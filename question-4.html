<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEB謎 - 問題4</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .chat-container {
            height: 400px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid transparent;
            border-image: var(--awesome-gradient) 1;
            padding: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 15px;
            max-width: 80%;
            animation: floatingElement 1s ease-out;
        }

        .ai-message {
            background: linear-gradient(45deg, #ff00ff33, #00ffff33);
            margin-right: auto;
            border-top-left-radius: 0;
            transform: skew(-2deg);
        }

        .user-message {
            background: linear-gradient(45deg, #00ffff33, #ff00ff33);
            margin-left: auto;
            border-top-right-radius: 0;
            transform: skew(2deg);
        }

        .input-section {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            box-shadow: var(--epic-shadow);
        }

        .question-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .question-select {
            padding: 10px;
            border: 2px solid var(--super-cool-color1);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            font-family: "Comic Sans MS", cursive;
            animation: rainbowText 3s infinite;
        }

        .question-input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--super-cool-color2);
            border-radius: 5px;
            font-family: "Comic Sans MS", cursive;
        }

        .final-answer-container {
            text-align: center;
            margin-top: 20px;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            text-align: center;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .message-content {
            word-break: break-word;
        }

        @media (max-width: 480px) {
            .chat-container {
                height: 350px;
                margin: 10px;
            }

            .question-input-container {
                flex-direction: column;
            }

            .question-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="question-container">
        <h1>問題4: 20の質問</h1>
        
        <div class="chat-container" id="chatContainer"></div>
        
        <div class="input-section">
            <div class="question-input-container">
                <select class="question-select" id="questionSelect">
                    <!-- 動的に利用可能な問題が追加されます -->
                </select>
                
                <input type="text" class="question-input" id="questionInput" placeholder="質問を入力してください...">
                
                <button type="button" class="submit-button" id="sendQuestion">
                    質問する
                </button>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                AIが考え中...✨
            </div>
            
            <div class="final-answer-container">
                <input type="text" class="answer-input" id="finalAnswer" placeholder="最終回答を入力...">
                <button type="submit" class="submit-button" id="submitAnswer">
                    回答する
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        class ChatPuzzle {
            constructor() {
                this.initializeChat();
                this.setupEventListeners();
                this.loadChatHistory();
                this.initializeQuestionSelect();
            }

            initializeChat() {
                this.chatContainer = document.getElementById('chatContainer');
                this.questionInput = document.getElementById('questionInput');
                this.questionSelect = document.getElementById('questionSelect');
                this.typingIndicator = document.getElementById('typingIndicator');
                
                // 初期メッセージ
                if (!this.getChatHistory().length) {
                    this.addMessage("私は何かを考えています。「はい」か「いいえ」で答えられる質問をしてください。", 'ai');
                }
            }

            initializeQuestionSelect() {
                // 現在のページ番号を取得（固定で4）
                const currentPage = 4;
                
                // 保存された進捗を取得
                const savedProgress = localStorage.getItem('puzzleProgress');
                const progress = Math.max(
                    currentPage,
                    savedProgress ? parseInt(savedProgress) : currentPage
                );

                // 進捗を保存
                if (!savedProgress || parseInt(savedProgress) < currentPage) {
                    localStorage.setItem('puzzleProgress', currentPage.toString());
                }

                // ドロップダウンをクリア
                this.questionSelect.innerHTML = '';

                // 選択肢を追加
                for (let i = 1; i <= progress; i++) {
                    const option = document.createElement('option');
                    option.value = i.toString();
                    option.textContent = `問題${i}`;
                    this.questionSelect.appendChild(option);
                }

                // 現在の問題を選択
                this.questionSelect.value = currentPage.toString();
            }

            setupEventListeners() {
                document.getElementById('sendQuestion').addEventListener('click', () => this.handleQuestion());
                document.getElementById('submitAnswer').addEventListener('click', () => this.checkAnswer());
                
                this.questionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleQuestion();
                });
                
                document.getElementById('finalAnswer').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.checkAnswer();
                });

                // 問題選択時にチャット履歴を切り替え
                this.questionSelect.addEventListener('change', () => {
                    this.loadChatHistory();
                });
            }

            async handleQuestion() {
                const question = this.questionInput.value.trim();
                if (!question) return;

                this.addMessage(question, 'user');
                this.questionInput.value = '';
                
                this.typingIndicator.style.display = 'block';
                
                // テスト用の応答を使用
                const response = await this.getMockResponse(question);
                
                this.typingIndicator.style.display = 'none';
                this.addMessage(response, 'ai');
            }

            async getMockResponse(question) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        // 質問を小文字化して空白を削除
                        const normalizedQuestion = question.toLowerCase().trim();

                        // キーワードベースの詳細な応答パターン
                        const keywordPatterns = [
                            // 基本的な特徴
                            {
                                keywords: ['動物', '生き物'],
                                response: "はい"
                            },
                            {
                                keywords: ['哺乳類', 'ほにゅう類'],
                                response: "はい"
                            },
                            {
                                keywords: ['植物', '無生物'],
                                response: "いいえ"
                            },

                            // 体の特徴
                            {
                                keywords: ['首', '首長', 'くび'],
                                response: "はい、とても長いです"
                            },
                            {
                                keywords: ['体', 'からだ', '大き'],
                                response: "はい、かなり大きいです"
                            },
                            {
                                keywords: ['足', 'あし', '脚'],
                                response: "はい、4本あります"
                            },
                            {
                                keywords: ['角', 'つの'],
                                response: "はい、小さな角があります"
                            },
                            {
                                keywords: ['毛', 'け', '模様'],
                                response: "はい、特徴的な模様があります"
                            },
                            {
                                keywords: ['しま', '縞'],
                                response: "いいえ、シマウマのような縞模様はありません"
                            },

                            // 生態・習性
                            {
                                keywords: ['草食', '草を食べ', '肉食'],
                                response: "はい、草食動物です"
                            },
                            {
                                keywords: ['泳', '水中', '海'],
                                response: "いいえ、基本的に陸上で生活します"
                            },
                            {
                                keywords: ['飛', '空'],
                                response: "いいえ、空は飛べません"
                            },

                            // 生息地・環境
                            {
                                keywords: ['アフリカ'],
                                response: "はい、主にアフリカに生息しています"
                            },
                            {
                                keywords: ['日本', '国内'],
                                response: "いいえ、野生では日本にはいません"
                            },
                            {
                                keywords: ['動物園'],
                                response: "はい、多くの動物園で見ることができます"
                            },

                            // サイズ関連
                            {
                                keywords: ['身長', '高さ'],
                                response: "はい、成体は非常に背が高いです"
                            },
                            {
                                keywords: ['体重', '重さ'],
                                response: "はい、かなりの重さがあります"
                            },

                            // 比較質問
                            {
                                keywords: ['象', 'ぞう'],
                                response: "いいえ、象ほどの大きさではありませんが、背は高いです"
                            },
                            {
                                keywords: ['ライオン', 'らいおん'],
                                response: "いいえ、肉食動物ではありません"
                            },
                            {
                                keywords: ['シマウマ', 'しまうま'],
                                response: "いいえ、縞模様はありませんが、同じアフリカに住んでいます"
                            },

                            // 特徴的な行動
                            {
                                keywords: ['走', 'はしる'],
                                response: "はい、走ることができますが、ゆっくり歩くことが多いです"
                            },
                            {
                                keywords: ['群れ', 'むれ'],
                                response: "はい、通常は群れで生活します"
                            },
                            {
                                keywords: ['鳴き声', 'なき声', '鳴く'],
                                response: "はい、独特な声を出すことがあります"
                            }
                        ];

                        // 否定形のチェック
                        const hasNegative = normalizedQuestion.includes('ない') || 
                                        normalizedQuestion.includes('ません') ||
                                        normalizedQuestion.includes('じゃない');

                        // 質問の種類を判断するヘルパー関数
                        const isValidQuestion = (q) => {
                            return q.includes('か') || q.includes('？') || q.includes('?');
                        };

                        // 回答を生成
                        let response = null;

                        // 有効な質問かチェック
                        if (!isValidQuestion(normalizedQuestion)) {
                            resolve("質問の形で聞いてください。例：「○○ですか？」");
                            return;
                        }

                        // キーワードマッチング
                        for (const pattern of keywordPatterns) {
                            if (pattern.keywords.some(keyword => normalizedQuestion.includes(keyword))) {
                                response = hasNegative ? 
                                    (pattern.response === "はい" ? "いいえ" : "はい") : 
                                    pattern.response;
                                break;
                            }
                        }

                        // デフォルトの応答
                        if (!response) {
                            const defaultResponses = [
                                "申し訳ありません。もう少し具体的に質問してください。",
                                "その質問には「はい」「いいえ」で答えることができます。別の質問をしてみてください。",
                                "質問の意図がよく分かりません。別の角度から質問してみてください。",
                                "もう少し具体的な特徴について質問してみてはどうでしょうか？"
                            ];
                            response = defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
                        }

                        resolve(response);
                    }, 1000);
                });
            }

            addMessage(content, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;
                
                messageDiv.appendChild(messageContent);
                this.chatContainer.appendChild(messageDiv);
                
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                
                // チャット履歴を保存
                const history = this.getChatHistory();
                history.push({ content, type });
                this.saveChatHistory(history);
            }

            getChatHistory() {
                const problemId = this.questionSelect.value;
                const history = localStorage.getItem(`chatHistory${problemId}`);
                return history ? JSON.parse(history) : [];
            }

            saveChatHistory(history) {
                const problemId = this.questionSelect.value;
                localStorage.setItem(`chatHistory${problemId}`, JSON.stringify(history));
            }

            loadChatHistory() {
                // チャット欄をクリア
                this.chatContainer.innerHTML = '';
                
                // 選択された問題のチャット履歴を読み込み
                const history = this.getChatHistory();
                history.forEach(message => {
                    this.addMessage(message.content, message.type);
                });
            }

            checkAnswer() {
                const answer = document.getElementById('finalAnswer').value.trim().toLowerCase();
                if (answer === 'きりん') {
                    // 進捗を更新
                    localStorage.setItem('puzzleProgress', '5');
                    // 次の問題へ
                    window.location.href = 'question-5.html';
                } else {
                    alert('不正解です。もう少し考えてみましょう。');
                    document.getElementById('finalAnswer').value = '';
                }
            }
        }

        // チャットパズルの初期化
        new ChatPuzzle();
    </script>
</body>
</html>